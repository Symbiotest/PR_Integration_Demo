import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;
import java.io.ByteArrayInputStream;

public class XXEVulnerability {
    
    // VULNERABLE: XML parsing with external entities enabled
    public static Document parseXMLUnsafe(String xmlData) throws Exception {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        // External entities are enabled by default
        return builder.parse(new ByteArrayInputStream(xmlData.getBytes()));
    }
    
    // Secure version: Disable external entities
    public static Document parseXMLSafe(String xmlData) throws Exception {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        
        // Disable external entities and DTDs
        factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
        factory.setFeature("http://xml.org/sax/features/external-general-entities", false);
        factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
        
        DocumentBuilder builder = factory.newDocumentBuilder();
        return builder.parse(new ByteArrayInputStream(xmlData.getBytes()));
    }
    
    public static void main(String[] args) {
        // Malicious XML that could exploit XXE
        String maliciousXML = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" +
                            "<!DOCTYPE foo [\n" +
                            "  <!ELEMENT foo ANY>\n" +
                            "  <!ENTITY xxe SYSTEM \"file:///etc/passwd\">\n" +
                            "]>\n" +
                            "<foo>&xxe;</foo>";
        
        try {
            // This would be vulnerable to XXE
            // Document doc = parseXMLUnsafe(maliciousXML);
            
            // This is the secure way to parse XML
            Document doc = parseXMLSafe(maliciousXML);
            System.out.println("XML parsed successfully with secure settings");
        } catch (Exception e) {
            System.err.println("Error parsing XML: " + e.getMessage());
        }
    }
}
